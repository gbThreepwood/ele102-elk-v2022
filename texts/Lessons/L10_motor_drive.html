<!DOCTYPE html>




<html lang="en">
  <head>
    <meta charset="utf-8" />
    
    <title>Motor Drives &mdash; ELE102 Microcontroller course v1.1.0 documentation</title>
    <meta name="description" content="">
    <meta name="author" content="">

    

<link rel="stylesheet" href="../../_static/css/basicstrap-base.css" type="text/css" />
<link rel="stylesheet" id="current-theme" href="../../_static/css/bootstrap3/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" id="current-adjust-theme" type="text/css" />

<link rel="stylesheet" href="../../_static/css/font-awesome.min.css">

<style type="text/css">
  body {
    padding-top: 60px;
    padding-bottom: 40px;
  }
</style>

<link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
<link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
<link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
<link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
<link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    
<script type="text/javascript">
  var DOCUMENTATION_OPTIONS = {
            URL_ROOT:    '../../',
            VERSION:     'v1.1.0',
            COLLAPSE_INDEX: false,
            FILE_SUFFIX: '.html',
            HAS_SOURCE:  true
  };
</script>
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery.min.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/javascript" src="../../_static/js/bootstrap3.min.js"></script>
<script type="text/javascript" src="../../_static/js/jquery.cookie.min.js"></script>
<script type="text/javascript" src="../../_static/js/basicstrap.js"></script>
<script type="text/javascript">
</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="ELE102 Microcontroller course v1.1.0 documentation" href="../../index.html" />
    <link rel="next" title="Additional material for lesson 1" href="../Lessons-additional/L1_additional.html" />
    <link rel="prev" title="Microcontroller architecture and Memory technology" href="L9_memory_and_architecture.html" /> 
  </head>
  <body role="document">
    <div id="navbar-top" class="navbar navbar-fixed-top navbar-default" role="navigation" aria-label="top navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../index.html">ELE102 Microcontroller course v1.1.0 documentation</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
              <li class="dropdown visible-xs">
                <a role="button" id="localToc" data-toggle="dropdown" data-target="#" href="#">Table Of Contents <b class="caret"></b></a>
                <ul class="dropdown-menu localtoc sp-localtoc" role="menu" aria-labelledby="localToc">
                <ul>
<li><a class="reference internal" href="#">Motor Drives</a><ul>
<li><a class="reference internal" href="#introduction-to-dc-motors">Introduction to DC motors</a><ul>
<li><a class="reference internal" href="#brushed-dc-motor-operation">Brushed DC motor operation</a></li>
<li><a class="reference internal" href="#transfer-function">Transfer function</a></li>
</ul>
</li>
<li><a class="reference internal" href="#brushed-dc-motor-drive">Brushed DC-motor drive</a><ul>
<li><a class="reference internal" href="#control-loops">Control loops</a></li>
<li><a class="reference internal" href="#motor-speed-adjusting-by-pwm">Motor Speed Adjusting by PWM</a><ul>
<li><a class="reference internal" href="#fast-pwm-mode">Fast PWM mode</a></li>
<li><a class="reference internal" href="#phase-correct-pwm">Phase correct PWM</a></li>
<li><a class="reference internal" href="#available-outputs">Available outputs</a></li>
<li><a class="reference internal" href="#four-quadrant-operation">Four quadrant operation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#simple-motor-drive-example-using-single-transistor">Simple motor drive example using single transistor</a></li>
<li><a class="reference internal" href="#exercise-start-and-stop-of-motor">Exercise: start and stop of motor</a></li>
<li><a class="reference internal" href="#lm293d-h-brigde">LM293D H-Brigde</a></li>
<li><a class="reference internal" href="#a-very-basic-example-for-the-lm293d">A very basic example for the LM293D</a></li>
<li><a class="reference internal" href="#a-slightly-more-complete-example-with-start-stop-and-emergency-stop">A slightly more complete example with start, stop, and emergency stop</a></li>
<li><a class="reference internal" href="#regenerative-braking-of-the-motor">Regenerative braking of the motor</a></li>
<li><a class="reference internal" href="#feature-rich-motor-drive-example-using-the-l293d">Feature rich motor drive example using the L293D</a></li>
<li><a class="reference internal" href="#exercise-lm293d-motor-drive">Exercise: LM293D motor drive</a></li>
<li><a class="reference internal" href="#exercise-motor-drive-with-acceleration-ramp">Exercise: motor drive with acceleration ramp</a></li>
<li><a class="reference internal" href="#advanced-motor-drive-example">Advanced motor drive example</a></li>
<li><a class="reference internal" href="#motor-drive-assignment">Motor drive assignment</a></li>
</ul>
</li>
<li><a class="reference internal" href="#bibliography">Bibliography</a></li>
</ul>
</li>
</ul>

                </ul>
              </li>

            
              <li><a href="L9_memory_and_architecture.html" title="Microcontroller architecture and Memory technology" accesskey="P">previous </a></li>
              <li><a href="../Lessons-additional/L1_additional.html" title="Additional material for lesson 1" accesskey="N">next </a></li>
              <li><a href="../../genindex.html" title="General Index" accesskey="I">index </a></li>
            

            <li class="visible-xs">
                <form class="search form-search form-inline navbar-form navbar-right sp-searchbox" action="../../search.html" method="get">
                  <div class="input-append input-group">
                    <input type="text" class="search-query form-control" name="q" placeholder="Search...">
                    <span class="input-group-btn">
                    <input type="submit" class="btn" value="Go" />
                    </span>
                  </div>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </li>

            

          </ul>

        </div>
      </div>
    </div>
    

    <!-- container -->
    <div class="container-fluid">

      <!-- row -->
      <div class="row">
         
<div class="col-md-3 hidden-xs" id="sidebar-wrapper">
  <div class="sidebar hidden-xs" role="navigation" aria-label="main navigation">
<h3><a href="../../index.html">Table of Contents</a></h3>
<p class="caption" role="heading"><span class="caption-text">Lessons:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="L0_Introduction_elk.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="software_hardware_preparations.html">Software and hardware preparations</a></li>
<li class="toctree-l1"><a class="reference internal" href="L1a_UC_intro.html">Lesson 1a: What is a Microcontroller</a></li>
<li class="toctree-l1"><a class="reference internal" href="L1b_Arduino_intro.html">Lesson 1b: Introduction to Arduino</a></li>
<li class="toctree-l1"><a class="reference internal" href="L2_digital_io.html">Lesson 2: Digital I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="L3_digital_io_and_timing.html">Lesson 3: Use of digital I/O and timing</a></li>
<li class="toctree-l1"><a class="reference internal" href="L4_dac_pwm.html">Lesson 4: Analog output (PWM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="L5_adc.html">Lesson 5: Analog to digital conversion (ADC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="L6_serial_io.html">Lesson 6: Serial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="L7_timer_interrupt.html">Lesson 7: Timers and interrupts</a></li>
<li class="toctree-l1"><a class="reference internal" href="L8_LC_display.html">Lesson 8: LC-Display</a></li>
<li class="toctree-l1"><a class="reference internal" href="L9_memory_and_architecture.html">Lesson 9: Memory and MCU architecture</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Lesson 10: Motor drive</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction-to-dc-motors">Introduction to DC motors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#brushed-dc-motor-operation">Brushed DC motor operation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transfer-function">Transfer function</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#brushed-dc-motor-drive">Brushed DC-motor drive</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#control-loops">Control loops</a></li>
<li class="toctree-l3"><a class="reference internal" href="#motor-speed-adjusting-by-pwm">Motor Speed Adjusting by PWM</a></li>
<li class="toctree-l3"><a class="reference internal" href="#simple-motor-drive-example-using-single-transistor">Simple motor drive example using single transistor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exercise-start-and-stop-of-motor">Exercise: start and stop of motor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lm293d-h-brigde">LM293D H-Brigde</a></li>
<li class="toctree-l3"><a class="reference internal" href="#a-very-basic-example-for-the-lm293d">A very basic example for the LM293D</a></li>
<li class="toctree-l3"><a class="reference internal" href="#a-slightly-more-complete-example-with-start-stop-and-emergency-stop">A slightly more complete example with start, stop, and emergency stop</a></li>
<li class="toctree-l3"><a class="reference internal" href="#regenerative-braking-of-the-motor">Regenerative braking of the motor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#feature-rich-motor-drive-example-using-the-l293d">Feature rich motor drive example using the L293D</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exercise-lm293d-motor-drive">Exercise: LM293D motor drive</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exercise-motor-drive-with-acceleration-ramp">Exercise: motor drive with acceleration ramp</a></li>
<li class="toctree-l3"><a class="reference internal" href="#advanced-motor-drive-example">Advanced motor drive example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#motor-drive-assignment">Motor drive assignment</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#bibliography">Bibliography</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional material:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L1_additional.html">Additional material lesson 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L2_additional.html">Additional material lesson 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L3_additional.html">Additional material lesson 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L4_additional.html">Additional material lesson 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L5_additional.html">Additional material lesson 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L6_additional.html">Additional material lesson 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L7_additional.html">Additional material lesson 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L8_additional.html">Additional material lesson 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L9_additional.html">Additional material lesson 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L10_additional.html">Additional material lesson 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L11_additional.html">Additional material lesson 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L12_additional.html">Additional material lesson 12</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Projects:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Appendices/Additionals.html">Mix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/ir_communication.html">Infrared remote</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/RC_car.html">Cool Project: RC Car (Bluetooth or Joystick)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/Robotarm.html">Cool Project: Simple Robot Arm (Bluetooth or Joystick)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Appendices:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Appendices/low_power_operation.html">Low power operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Appendices/stacks_queues_lists.html">Lesson Stacks, Queues, Lists</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Appendices/assembly_programming.html">Assembly programming</a></li>
</ul>

<div id="searchbox" role="search">
  <h3>Quick search</h3>
  <form class="search form-inline" action="../../search.html" method="get">
      <div class="input-append input-group">
        <input type="text" class="search-query form-control" name="q" placeholder="Search...">
        <span class="input-group-btn">
        <input type="submit" class="btn" value="Go" />
        </span>
      </div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="L9_memory_and_architecture.html"
                          title="previous chapter">Microcontroller architecture and Memory technology</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="../Lessons-additional/L1_additional.html"
                          title="next chapter">Additional material for lesson 1</a></p>
  </div>
  </div>
</div> 
        

        <div class="col-md-9" id="content-wrapper">
          <div class="document" role="main">
            <div class="documentwrapper">
              <div class="bodywrapper">
                <div class="body">
                  
  <span class="target" id="l8-motor-drive"></span><div class="section" id="motor-drives">
<h1>Motor Drives<a class="headerlink" href="#motor-drives" title="Permalink to this headline">¶</a></h1>
<p>In general a motor drive is a power electronic device used to control the power delivered to a motor. The purpose could be either torque, speed or position control of the rotating motor shaft. At a high level the motor drive consists of a controller, and an amplifier (power electronics) which amplify the output from the controller to levels sufficient to drive the motor.</p>
<p>There are many different types of motors in existence, and each type warrants its own particular motor drive design. Unless the controller is very simple, microcontrollers are typically used for the controller, and the power electronics will be selected depending on type and size of the motor.</p>
<p><strong>DC Motors:</strong> This is a very common motor in cheap low power applications. We can see it in remote control cars, robots, etc. This motor has a simple structure. It will start rolling by applying proper voltage to its terminals and change it’s rotational direction by switching voltage polarity. The DC motor torque (and thus speed) is directly controlled by the applied current. Current depends on voltage, and thus a voltage level less than the maximum tolerable voltage, will cause a speed that is less than maximum speed. By varying the applied voltage we will in practice wary the speed of the motor.</p>
<p><strong>Stepper Motors:</strong> In some projects such as 3D printers, scanners and CNC machines we need to know motor spin steps accurately. In these cases, we may use stepper motors. Stepper motor are electric motors that divides a full rotation into a number of equal steps. The amount of rotation per step is determined by the motor structure. These kind of motors may be designed to have a very high accuracy if needed.</p>
<p><strong>Servo Motors:</strong> There are many different types of motors that could be considered as servo motors. What they have in common it that they typically provide position control service. By using a servo you will be able to control the amount of shafts rotation and move it to a specific position. They usually have a small dimension and are the best choice for applications such as robotic arms.</p>
<p><strong>AC motors</strong> Three phase AC motors are by far the largest consumer of electrical energy in the world. There are many different varieties of AC motors, but the type known as the induction motor serves a particularly important role in industry. This type of motor is typically used in applications where accuracy is less important, and for a very wide range of power levels from watts to megawatts. Examples include the driving of pumps, fans, drums, batching plants etc.</p>
<p>It is typically not possible to connect motors to microcontrollers or controller board such as Arduino directly. Unless the motor is really small it will require more current than the controller is able to supply. The Arduino UNO has a maximum drive capability of 40 mA on each pin. Thus we need some form of circuit to amplify the signal from the controller, this kind of circuit is called motor driver, or motor drive. The driver is an interface circuit between the motor and controlling unit to facilitate driving. Drives come in many different types <span id="id1">[]</span>.</p>
<p>In this lecture we will look at DC-motor drives. The understanding of DC-motor drives is a good foundation for understanding more advanced AC-motor drives.</p>
<div class="section" id="introduction-to-dc-motors">
<h2>Introduction to DC motors<a class="headerlink" href="#introduction-to-dc-motors" title="Permalink to this headline">¶</a></h2>
<p>DC motors are divided into 2 main categories: <em>brushed</em> and <em>brushless</em> DC motors. We can define a brushed DC motor as a motor with internal mechanical commutation. It is designed to be powered by a direct current source. On the other hand, in the brushless DC motors, there is no physical contact between coils and the field magnet (stationary and rotaty parts). The brushless DC motor is really an AC motor with a electronic DC to AC converter placed inside the motor housing.</p>
<p>A brushless DC motor uses a permanent magnet as its external rotor and there are three phases of coils surrounding it. A specialized sensor is also typically placed in the setup to track the position of the rotor as it is moving, where the rotor position signals are being sent to a controller. A term often used for these devices is ESC (electronic speed controller). The ESC regulates the motor speed in order to track some reference speed, and can also provide dynamic braking where the rotational energy of the motor is converted back to electrical energy.</p>
<div class="figure align-center" id="id8">
<img alt="../../_images/Brushed-and-Brushless-DC-motors.jpg" src="../../_images/Brushed-and-Brushless-DC-motors.jpg" />
<p class="caption"><span class="caption-text">Source: <a class="reference external" href="https://www.meee-services.com/why-do-dc-motors-have-brushes/">https://www.meee-services.com/why-do-dc-motors-have-brushes/</a></span><a class="headerlink" href="#id8" title="Permalink to this image">¶</a></p>
</div>
<p>A brushed motor on the other hand, has a mechanical DC to AC converter (commutator), and the primary current is flowing in the rotor. As the rotor rotates so does the commutator, this causes the supply current to move to different coils and thus the direction of the generated magnetic field also moves.</p>
<p>..a configuration of wound wire coils, carrying out the duties of a two-pole electromagnet. The direction of the current is controlled by the commutator and this ensures the flow through the armature.</p>
<p>Brushed DC motors have been in commercial use since 1886. Brushless motors, on the other hand, did not become commercially viable until 1962. Brushed DC motors develop a maximum torque when stationary, linearly decreasing as velocity increases. Some limitations of brushed motors can be overcome by brushless motors; they include higher efficiency and a lower susceptibility to mechanical wear. These benefits come at the cost of potentially less rugged, more complex, and more expensive control electronics <span id="id2">[]</span>.</p>
<div class="figure align-center" id="id9">
<img alt="../../_images/dcMotor.jpg" src="../../_images/dcMotor.jpg" />
<p class="caption"><span class="caption-text">Source: <a class="reference external" href="https://www.motioncontrolonline.org/blog-article.cfm/Brushed-DC-Motors-Vs-Brushless-DC-Motors/24">https://www.motioncontrolonline.org/</a></span><a class="headerlink" href="#id9" title="Permalink to this image">¶</a></p>
</div>
<div class="section" id="brushed-dc-motor-operation">
<h3>Brushed DC motor operation<a class="headerlink" href="#brushed-dc-motor-operation" title="Permalink to this headline">¶</a></h3>
<p>A brushed DC-motor has a torque proportional to the current passing through the armature of the motor <span id="id3">[]</span>.</p>
<div class="math notranslate nohighlight">
\[T_{em} = (2 B_f \ell_r ) i_a\]</div>
<p>If the magnetic field of the stator is constant, the only variable in the torque equation is the armature current. Hence we can write:</p>
<div class="math notranslate nohighlight">
\[T_{em} = k_T \cdot I_a\]</div>
<p>Where <span class="math notranslate nohighlight">\(k_T\)</span> is the torque constant for the motor, and <span class="math notranslate nohighlight">\(I_a\)</span> is the armature current.</p>
<p>As the windings of the rotor interact with the stator magnetic field, an electromotive force (EMF) is produced. This is a voltage and is proportional to the angular velocity (speed) of the rotor:</p>
<div class="math notranslate nohighlight">
\[e = k_e \cdot \omega_m\]</div>
<p>Where <span class="math notranslate nohighlight">\(k_e\)</span> is the EMF constant for the motor, and <span class="math notranslate nohighlight">\(\omega_m\)</span> is the mechanical angular velocity. Based upon Newtons second law the following equation can be derived:</p>
<div class="math notranslate nohighlight">
\[J \frac{\mathrm{d}\omega_m}{\mathrm{d}t} + B \omega_m = k_T \cdot i_a - T_L\]</div>
<p>Where <span class="math notranslate nohighlight">\(J\)</span> is the moment of inertia, <span class="math notranslate nohighlight">\(B\)</span> is the coefficient of viscous friction, and <span class="math notranslate nohighlight">\(T_L\)</span> is the load torque.</p>
<p>Futhermore based on Kirchhoffs voltage law the following electrical equation is derived:</p>
<div class="math notranslate nohighlight">
\[L \frac{\mathrm{d}i_a}{\mathrm{d}t} + R i_a = V_a - K_e \omega_m\]</div>
<p>If we use SI units, the torque constant, and the EMF constant has the exact same numerical value:</p>
<div class="math notranslate nohighlight">
\[k_T = k_e = k\]</div>
</div>
<div class="section" id="transfer-function">
<h3>Transfer function<a class="headerlink" href="#transfer-function" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>An understanding of the transfer function is not required for the exercises in this lesson, but is important for closed loop control of the DC-motor. It is included here for completeness.</p>
</div>
<p>The transfer function is very useful when analyzing the transient behavior of the motor. By using the laplace transform, we arrive at the following results for the mechanical and electrical differential equations:</p>
<div class="math notranslate nohighlight">
\[s(Js + B) \theta(s) = k_T I_a(s) \Rightarrow s^2J \theta(s) + sB\theta(s) = k_T I_a(s)\]</div>
<div class="math notranslate nohighlight">
\[(R_a + sL_a) I_a(s) = V_a(s) - s K_e \theta(s) \Rightarrow (R_a + sL_a) I_a(s) = V_a(s) - K_e \omega_m(s)\]</div>
<div class="math notranslate nohighlight">
\[s J \omega_m(s) + B \omega_m(s) = k_T I_a(s) \Rightarrow (sJ + B) \omega_m(s) = k_T I_a(s)\]</div>
<p>A transfer function relates some input to some output. We have several possible transfer functions for the DC motor depending on the value which is of interest.</p>
<ul class="simple">
<li><p>The motor speed for a given armature voltage</p></li>
<li><p>The motor speed for a given torque</p></li>
<li><p>The motor armature current for a given armature voltage</p></li>
<li><p>The motor armature current for a given torque</p></li>
</ul>
<p>The armature current can be expressed as:</p>
<div class="math notranslate nohighlight">
\[I_a(s) = \frac{V_a(s) - k_e \omega_m(s)}{R_a + sL_a}\]</div>
<p>The armature angular velocity can be expressed as:</p>
<div class="math notranslate nohighlight">
\[\omega_m(s) = \frac{k_T I_a(s) - T_L}{sJ + B}\]</div>
<p>Neglecting the load torque <span class="math notranslate nohighlight">\(T_L\)</span> and remembering that <span class="math notranslate nohighlight">\(k_T = k_e = k\)</span>, we can write:</p>
<div class="math notranslate nohighlight">
\[\omega_m(s) = \cfrac{k_T \cfrac{V_a(s) - k_e \omega_m(s)}{R_a + sL_a}}{sJ + B} = \frac{k V_a(s) - k^2 \omega_m(s)}{(R_a + sL_a)(sJ + B)}\]</div>
<p>We want to solve for <span class="math notranslate nohighlight">\(\frac{\omega_m}{V_a}\)</span>, we start by isolating <span class="math notranslate nohighlight">\(\omega_m\)</span>:</p>
<div class="math notranslate nohighlight">
\[\frac{\omega_m}{k} \cdot (R_a + sL_a)(sJ + B) + k \omega_m = V_a \Rightarrow \omega_m \left(\frac{(R_a + sL_a)(sJ + B)}{k} + k \right) = V_a\]</div>
<p>Multiplying by <span class="math notranslate nohighlight">\(\frac{k}{k}\)</span> in the second term we can write:</p>
<div class="math notranslate nohighlight">
\[\omega_m \left(\frac{(R_a + sL_a)(sJ + B) + k^2}{k} \right) = V_a\]</div>
<p>Thus the transfer function between speed and applied voltage is given by:</p>
<div class="math notranslate nohighlight">
\[H_{\omega}(s) = \frac{\omega_m(s)}{V_a(s)} = \frac{k}{(Js + B)(Ls + R) + k^2}\]</div>
<p>Similar derivations can be performed for the other transfer functions if needed.</p>
<p>By choosing the mechanical angular velocity and the armature current as state variables, we arrive at the following state-space representation for the motor:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\frac{\mathrm{d}}{\mathrm{d}t}
\begin{bmatrix}
\omega_m \\
i_a
\end{bmatrix}
=
\begin{bmatrix}
-\frac{B}{J} &amp; \frac{K}{J} \\
-\frac{K}{L} &amp; -\frac{R}{L}
\end{bmatrix}
\begin{bmatrix}
\omega_m \\
i_a
\end{bmatrix}
+
\begin{bmatrix}
0 \\
\frac{1}{L}
\end{bmatrix}
V_a\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}y =
\begin{bmatrix}
1 &amp; 0
\end{bmatrix}
\begin{bmatrix}
\omega_m \\
i_a
\end{bmatrix}\end{split}\]</div>
<p>It can be insightful to define and use time constants in the transfer function expressions. A mechanical time constant can be expressed as:</p>
<div class="math notranslate nohighlight">
\[\tau_m = \frac{J \cdot \omega_{m,N}^2}{P_{e,N}}\]</div>
<p>A electrical time constant for the armature circuit can be defined as:</p>
<div class="math notranslate nohighlight">
\[\tau_e = \frac{L_a}{R_a}\]</div>
</div>
</div>
<div class="section" id="brushed-dc-motor-drive">
<h2>Brushed DC-motor drive<a class="headerlink" href="#brushed-dc-motor-drive" title="Permalink to this headline">¶</a></h2>
<p>In this section we will cover how to control a brushed DC-motor by the Arduino UNO.</p>
<div class="section" id="control-loops">
<h3>Control loops<a class="headerlink" href="#control-loops" title="Permalink to this headline">¶</a></h3>
<p>From a mechanical point of view we have several possible control objectives:</p>
<ul class="simple">
<li><p>Torque control (current control, as mechanical torque is proportional to current)</p></li>
<li><p>Speed control and control of rotational direction</p></li>
<li><p>Position control</p></li>
</ul>
<p>The three control objectives in the above list are obviously related to each other. The change in position depend on the speed, and the change in speed depend on the torque. Hence we will often find that a cascaded control structure is used, e.g. the reference input to the torque controller could be the output from the speed controller. Accurate control required feedback, this could be in the form of a current sensor measuring the armature current, and a mechanical speed or position sensor on the motor shaft.</p>
<p>If you simply apply a voltage to the motor armature this will result is some current, which in turn causes torque and rotation of the motor. This is called open loop control since you not feeding back any of the resulting motor states, i.e. the control loop is not closed.. If you are not measuring anything it is hard to tell what the exact operating conditions (e.g. the speed of the motor) will be, but some previous knowledge about the system can allow you to estimate. E.g. by previous measurements you might know that in a given load situation applying 12 V will cause a speed of approximately 1000 RPM.</p>
<p>Closed loop control requires additional sensors, and knowledge of control theory. Thus In this lesson we will only consider open loop control, this is the foundation upon which closed loop control can be built in a future lecture.</p>
<img alt="../../_images/current_sensor.avif" class="align-center" src="../../_images/current_sensor.avif" />
</div>
<div class="section" id="motor-speed-adjusting-by-pwm">
<h3>Motor Speed Adjusting by PWM<a class="headerlink" href="#motor-speed-adjusting-by-pwm" title="Permalink to this headline">¶</a></h3>
<p>The most common way to vary the voltage level (and for AC motors also the frequency) in modern motor drives is by using pulse width modulation. A basic understanding of this concept is essential for anyone designing such drives.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As this course is a basic course we will not have time to go into all the details of how the PWM operates.</p>
</div>
<p>The Atmega 328 supports two major types of PWM:</p>
<ul class="simple">
<li><p>Fast PWM</p></li>
<li><p>Phase correct PWM</p></li>
</ul>
<div class="section" id="fast-pwm-mode">
<h4>Fast PWM mode<a class="headerlink" href="#fast-pwm-mode" title="Permalink to this headline">¶</a></h4>
<p>The frequency of the fast PWM mode is given by:</p>
<div class="math notranslate nohighlight">
\[f_{pwm} = \frac{\text{clock_speed}}{ \text{prescaler} \cdot (1 + \text{top_value})}\]</div>
<p>Where clock_speed is the speed of the Arduino CPU clock (16 MHz by default). The prescaler is a number that is scaling the clock, and top_value is the maximum value of the counter.</p>
</div>
<div class="section" id="phase-correct-pwm">
<h4>Phase correct PWM<a class="headerlink" href="#phase-correct-pwm" title="Permalink to this headline">¶</a></h4>
<p>The phase correct PWM is a mode where the phase of the PWM signal remains constant. This is important in some applications, such as AC motor drives.</p>
<div class="math notranslate nohighlight">
\[f_{pwm} = \frac{\text{clock_speed}}{2 \cdot \text{prescaler} \cdot \text{top_value}}\]</div>
</div>
<div class="section" id="available-outputs">
<h4>Available outputs<a class="headerlink" href="#available-outputs" title="Permalink to this headline">¶</a></h4>
<p>The outputs that support PWM are labeled with a small sine wave symbol (actually a tilde  “~”) on the Arduino board. The following table lists some important information regarding the PWM outputs. The <cite>switching frequency</cite> is only the default value. It may be changed by direct register manipulation, but the Arduino library does not have any functions to change it.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 26%" />
<col style="width: 24%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Pin number</p></td>
<td><p>Timer</p></td>
<td><p>Switching frequency</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>2</p></td>
<td><p>490 Hz</p></td>
</tr>
<tr class="row-odd"><td><p>5</p></td>
<td><p>0</p></td>
<td><p>980 Hz</p></td>
</tr>
<tr class="row-even"><td><p>6</p></td>
<td><p>0</p></td>
<td><p>980 Hz</p></td>
</tr>
<tr class="row-odd"><td><p>9</p></td>
<td><p>1</p></td>
<td><p>490 Hz</p></td>
</tr>
<tr class="row-even"><td><p>10</p></td>
<td><p>1</p></td>
<td><p>490 Hz</p></td>
</tr>
<tr class="row-odd"><td><p>11</p></td>
<td><p>2</p></td>
<td><p>490 Hz</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="four-quadrant-operation">
<h4>Four quadrant operation<a class="headerlink" href="#four-quadrant-operation" title="Permalink to this headline">¶</a></h4>
<p>The rotating shaft of an electric machine has two fundamental parameters, torque and speed. The speed may be forward or reverse, and the torque may be motoring or braking. Thus we have four possible modes of operation, i.e. four quadrant operation.</p>
<div class="figure align-center" id="id10">
<img alt="../../_images/four-quadrant-operatio-fig-compressor.jpg" src="../../_images/four-quadrant-operatio-fig-compressor.jpg" />
<p class="caption"><span class="caption-text">Source: <a class="reference external" href="https://circuitglobe.com/four-quadrant-operation-of-dc-motor.html">https://circuitglobe.com/four-quadrant-operation-of-dc-motor.html</a></span><a class="headerlink" href="#id10" title="Permalink to this image">¶</a></p>
</div>
<p>For a brushed DC-motor it is possible to operate in all four quadrants by controlling the voltage applied to the armature. The motor drive must have the ability to control both the magnitude, and polarity of the voltage, and the circuit must allow the current to flow in both directions.</p>
<p>When the drive is operating in a mode with negative torque with respect to the rotating direction it is said to be in breaking (generator) mode. In this mode the energy is flowing from the motor back to the power source.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<ul class="simple">
<li><p>How a brushed DC works: <a class="reference external" href="https://www.youtube.com/watch?v=LAtPHANEfQo">BDC principle</a></p></li>
<li><p>How a brushless DC works: <a class="reference external" href="https://www.youtube.com/watch?v=bCEiOnuODac">BLDC principle</a></p></li>
<li><p>Practical demonstration of the four quadrant operation: <a class="reference external" href="https://www.youtube.com/watch?v=51yZrXBlCQY">four quadrant</a></p></li>
<li><p>Speed-Torque relation in efficiency: <a class="reference external" href="https://www.semanticscholar.org/paper/Improved-torque-and-efficiency-of-a-four-switch-fed-Ekong-Inamori/60a9c55e2cead93ec4f68dc99f93be5647d07c88">Motor efficiency map of a DC motor</a></p></li>
</ul>
</div>
<p>..Motor Direction Setting by Switching
.. ————————————-</p>
</div>
</div>
<div class="section" id="simple-motor-drive-example-using-single-transistor">
<h3>Simple motor drive example using single transistor<a class="headerlink" href="#simple-motor-drive-example-using-single-transistor" title="Permalink to this headline">¶</a></h3>
<p>In this example we will be using a <cite>IFR520N</cite> transistor to drive the small DC-motor that comes as part of the Arduino starter kit. The <a class="reference external" href="https://www.vishay.com/docs/91017/91017.pdf">IRF520N datasheet</a> provides the required details on the electrical limitations of the transistor, but for this example you should only trust us in that it will operate within limits.</p>
<p>The function <code class="code ccode c docutils literal notranslate"><span class="pre">analogWrite()</span></code> will be used to generate a PWM signal to the transistor, and the switching frequency will stay at it’s default value.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/dc_motor_drive_single_transistor_bb.png"><img alt="../../_images/dc_motor_drive_single_transistor_bb.png" src="../../_images/dc_motor_drive_single_transistor_bb.png" style="width: 784.5px; height: 660.0px;" /></a>
</div>
</div>
<div class="section" id="exercise-start-and-stop-of-motor">
<h3>Exercise: start and stop of motor<a class="headerlink" href="#exercise-start-and-stop-of-motor" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Do the wiring according to the previous drawing</p></li>
<li><p>Add code to properly read, edge detect, and debounce a push button</p></li>
<li><p>Use the rising edge of the push button to toggle the motor driver on, or off. The duty cycle should be 50%.</p></li>
<li><p>Read a parameter from the UART, which is used to set the duty cycle. The parameter should be a number between 0, and 100. Anything else should produce an error message.</p></li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span><span class="cp"></span>

<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">pwm_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">on_off_button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">old_button_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">motor_enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">pwm_pin</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">on_off_button</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">button_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">on_off_button</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">button_state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">old_button_state</span><span class="p">){</span><span class="w"></span>

<span class="w">    </span><span class="n">old_button_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">button_state</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// TODO: This code requires debouncing of the push button.</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">button_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">motor_enable</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Motor disabled.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">analogWrite</span><span class="p">(</span><span class="n">pwm_pin</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">motor_enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Motor enabled.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">analogWrite</span><span class="p">(</span><span class="n">pwm_pin</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">motor_enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>


<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="lm293d-h-brigde">
<h3>LM293D H-Brigde<a class="headerlink" href="#lm293d-h-brigde" title="Permalink to this headline">¶</a></h3>
<p>An H bridge is an electronic circuit that switches the polarity of a voltage applied to a load. These circuits are often used in robotics and other applications to allow DC motors to run forwards or backwards <span id="id4">[]</span>.</p>
<p>This section provides a basic overview of the LM293D driver. More details about are available in the <a class="reference external" href="https://www.st.com/resource/en/datasheet/l293d.pdf">datasheet</a></p>
<img alt="../../_images/l293d_package.png" class="align-center" src="../../_images/l293d_package.png" />
<p>The L293D is a quadruple high-current half-H driver. The D in the name signifies that this version incorporates diodes on the outputs. It has a maximum output current of 600 mA, a maximum switching frequency of 5 kHz, and supports a voltage range from 4.5 to 36 V.</p>
<img alt="../../_images/l293d_logic_diagram.png" class="align-center" src="../../_images/l293d_logic_diagram.png" />
<p>Depending on the degree of control that your application requires there are several possible ways to connect the motor.</p>
<img alt="../../_images/l293d_motor_connection_examples.png" class="align-center" src="../../_images/l293d_motor_connection_examples.png" />
<p>The following tables provides an overview of the possible control signal inputs, and the effect they will have in a DC motor drive application.</p>
<div class="figure align-center" id="id11">
<img alt="../../_images/table-3-part-1.png" src="../../_images/table-3-part-1.png" />
<p class="caption"><span class="caption-text">Source: <a class="reference external" href="https://www.ti.com/lit/ds/symlink/l293.pdf">The L293 datasheet</a></span><a class="headerlink" href="#id11" title="Permalink to this image">¶</a></p>
</div>
<div class="figure align-center">
<img alt="../../_images/table-3-part-2.png" src="../../_images/table-3-part-2.png" />
</div>
</div>
<div class="section" id="a-very-basic-example-for-the-lm293d">
<h3>A very basic example for the LM293D<a class="headerlink" href="#a-very-basic-example-for-the-lm293d" title="Permalink to this headline">¶</a></h3>
<p>The following code listing provides a very basic example on how to set a specific operating mode for the LM293D motor driver. Two digital outputs on pin 4, and 5 are used to set the rotational direction for the motor by setting the voltage polarity. A third digital output on pin 6 is used to provide a PWM signal to the enable input which causes the voltage applied to the motor to switch on and off quickly.</p>
<p>The motor supply voltage pin is connected to the 5 V output from the Arduino. This is fine for a small motor, but larger motors with high current or voltage rating will require an external supply to this pin.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span><span class="cp"></span>

<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">en_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">a1_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">a2_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>


<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">en_pin</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">a1_pin</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">a2_pin</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">a1_pin</span><span class="p">,</span><span class="w"> </span><span class="n">HIGH</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">a2_pin</span><span class="p">,</span><span class="w"> </span><span class="n">LOW</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">analogWrite</span><span class="p">(</span><span class="n">en_pin</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Nothing to do here..</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Applying PWM to the 1A, and 2A pins will also cause the output voltage to be modulated. This will not have the exact same effect though. The difference is outlined later in the lesson.</p>
</div>
</div>
<div class="section" id="a-slightly-more-complete-example-with-start-stop-and-emergency-stop">
<h3>A slightly more complete example with start, stop, and emergency stop<a class="headerlink" href="#a-slightly-more-complete-example-with-start-stop-and-emergency-stop" title="Permalink to this headline">¶</a></h3>
<p>The emergency stop is implemented by forcing the motor to stop as quickly as possible. By setting both 1A, and 2A low (or high) simultaneously while keeping the EN signal high the motor terminals will be short circuited to each other. This will cause a large current to flow in the motor windings, and the rotational energy will be dissipated as heat in the winding resistance.</p>
</div>
<div class="section" id="regenerative-braking-of-the-motor">
<h3>Regenerative braking of the motor<a class="headerlink" href="#regenerative-braking-of-the-motor" title="Permalink to this headline">¶</a></h3>
<p>It is relatively straight forward to apply control signals which converts the rotational energy of the brushed DC motor back to electrical energy. This is the most energy efficient way of breaking the motor, as the energy can be recovered and used again for another purpose. Regenerative operation on the arduino board can be problematic, as the USB power supply does not support reversed energy flow. The same is true if the supply comes from a battery which is not rechargeable. If one is pushing energy in to a DC source which does not support regenerative operation, the result will typically be that the voltage at the filtering capacitors in the DC section will increase. At some point the voltage will exceed the rating of the capacitors, and magic smoke will come out. Thus the first ting you have to do before considering regenerative operation, is to verify that the source will be able to handle it.</p>
<p>The trick to achieve regenerative braking it to increase the voltage coming from the motor to a level above the source voltage which was previously supplying the motor. This will allow the current direction to reverse, and thus the power flow will also be reversed. The voltage produced by the motor is proportional to the speed as well as on the magnetic field in the stator. It will always be lower than the source voltage, unless one of the following conditions are met:</p>
<ul class="simple">
<li><p>For a electrically excited DC motor, if the field current is increased.</p></li>
<li><p>For any DC motor if some external mechanical force is driving the motor to a sufficiently high speed.</p></li>
</ul>
<p>Unless you have a field winding (the small DC motor in the examples provided in this lesson does not) you will have to increase the induced voltage after it has been generated. In order to increase the motor voltage an additional external voltage converter (these are known as boost converters) could have been placed between the motor and the source, and activated when entering breaking mode. It turns out however that it is possible to exploit the internal inductance of the motor in order to increase (boost) the voltage.</p>
<p>If the transistors are switched correctly and at an appropriate switching frequency the only condition needed to obtain the regenerative braking is that the duty cycle of the PWM in reduced to a value below the previous steady state duty cycle. The following block diagram gives some insight in to the internal operation of the L293D:</p>
<blockquote>
<div><div class="figure align-center">
<img alt="L238D detailed block diagram" src="../../_images/l293d-detailed-block-diagram.png" />
</div>
<p>Source: <a class="reference external" href="https://www.ti.com/lit/ds/symlink/l293.pdf">The L293 datasheet</a></p>
</div></blockquote>
<p>For each of the four drivers we have the following truth (function) table:</p>
<blockquote>
<div><div class="figure align-center">
<img alt="L293D driver output truth table" src="../../_images/l293d-driver-truth-table.png" />
</div>
<p>Source: <a class="reference external" href="https://www.ti.com/lit/ds/symlink/l293.pdf">The L293 datasheet</a></p>
</div></blockquote>
<p>If the enable (EN) signal is low, the control signal (A) is ignored and the output goes in to a high impedance (high Z) state. When the enable signal is high, the output follows the control signal (A). By applying PWM to the enable signal and leaving the A signals fixed regenerative braking will be impossible. Whenever the output is in a high Z state, the motor current will have to circulate through the freewheeling diodes. If however the PWM signal is applied to e.g. 1A while 2A is low, a reduction in duty cycle will allow the voltage to be boosted by the motor inductance. For the opposite rotational direction the PWM signal should be applied to 2A while 1A is low.</p>
</div>
<div class="section" id="feature-rich-motor-drive-example-using-the-l293d">
<h3>Feature rich motor drive example using the L293D<a class="headerlink" href="#feature-rich-motor-drive-example-using-the-l293d" title="Permalink to this headline">¶</a></h3>
<p>The following example is a slightly more complete implementation of motor control using the L293D driver. The implementation uses one push button for starting, and one for stopping the motor. The voltage on analog input <cite>A0</cite> is used to control the duty cycle of the pulse width modulation.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/dc_motor_drive_potmeter_control_bb.png"><img alt="../../_images/dc_motor_drive_potmeter_control_bb.png" src="../../_images/dc_motor_drive_potmeter_control_bb.png" style="width: 757.5px; height: 661.5px;" /></a>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span><span class="cp"></span>

<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">input_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">input_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">start_button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">stopp_button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">control_voltage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A0</span><span class="p">;</span><span class="w"></span>

<span class="kt">uint8_t</span><span class="w"> </span><span class="nf">start_button_event</span><span class="p">();</span><span class="w"></span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="nf">stopp_button_event</span><span class="p">();</span><span class="w"></span>

<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">FORWARD</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">REVERSE</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">STOPPED</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">rot_direction_t</span><span class="p">;</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">motor_control</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">rot_direction_t</span><span class="w"> </span><span class="n">direction</span><span class="p">);</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">input_1</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">input_2</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">motor_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">old_millis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">serial_old_millis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">adc_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">duty_cycle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">old_millis</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">50</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">adc_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">analogRead</span><span class="p">(</span><span class="n">control_voltage</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">duty_cycle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">adc_value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">old_millis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">serial_old_millis</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1000</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Duty cycle: &quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">serial_old_millis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">motor_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span><span class="w"></span>
<span class="w">   </span>
<span class="w">    </span><span class="n">motor_control</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">STOPPED</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">start_button_event</span><span class="p">()){</span><span class="w"></span>
<span class="w">      </span><span class="n">motor_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">motor_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span><span class="w"></span>

<span class="w">    </span><span class="n">motor_control</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">FORWARD</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">stopp_button_event</span><span class="p">()){</span><span class="w"></span>
<span class="w">      </span><span class="n">motor_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">motor_control</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">rot_direction_t</span><span class="w"> </span><span class="n">direction</span><span class="p">){</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FORWARD</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">input_1</span><span class="p">,</span><span class="w"> </span><span class="n">HIGH</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">input_2</span><span class="p">,</span><span class="w"> </span><span class="n">LOW</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">REVERSE</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">input_1</span><span class="p">,</span><span class="w"> </span><span class="n">LOW</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">input_2</span><span class="p">,</span><span class="w"> </span><span class="n">HIGH</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">STOPPED</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">input_1</span><span class="p">,</span><span class="w"> </span><span class="n">LOW</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">input_2</span><span class="p">,</span><span class="w"> </span><span class="n">LOW</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">analogWrite</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span><span class="w"> </span><span class="n">duty_cycle</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">//digitalWrite(enable, HIGH);</span>
<span class="p">}</span><span class="w"></span>

<span class="kt">uint8_t</span><span class="w"> </span><span class="nf">start_button_event</span><span class="p">(){</span><span class="w"></span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">shift_register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">old_millis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">old_millis</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">){</span><span class="w"></span>

<span class="w">    </span><span class="n">old_millis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">input_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">start_button</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">shift_register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">shift_register</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">input_state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0xC000</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">shift_register</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xE000</span><span class="p">){</span><span class="w"></span>
<span class="w">      </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Start event detected.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">uint8_t</span><span class="w"> </span><span class="nf">stopp_button_event</span><span class="p">(){</span><span class="w"></span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">shift_register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">old_millis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">old_millis</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">){</span><span class="w"></span>

<span class="w">    </span><span class="n">old_millis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">input_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">stopp_button</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">shift_register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">shift_register</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">input_state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0xC000</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">shift_register</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xE000</span><span class="p">){</span><span class="w"></span>
<span class="w">      </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Stop event detected.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="exercise-lm293d-motor-drive">
<h3>Exercise: LM293D motor drive<a class="headerlink" href="#exercise-lm293d-motor-drive" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Use the L293D motor driver and perform the necessary wiring. There should be 3 push buttons and a potentiometer.</p></li>
<li><p>Write an application which takes the armature voltage (motor speed) set point as a input from a potentiometer.</p></li>
<li><p>Read the signals from three push buttons with proper debouncing, and edge detection.</p></li>
<li><p>Add the code to use the first push button to toggle between start and stop.</p></li>
<li><p>Add the code to use the second push button to toggle the rotational direction. The program should only allow the direction to change if the motor is first stopped.</p></li>
<li><p>Add the code for emergency stop on the third button. If pressed the program should go in to emergency stop mode, and stay there until the controller receives the command “reset”, or “RESET” from the UART.</p></li>
<li><p>Test the program, and write a short description about the behavior of your code.</p></li>
</ol>
</div>
<div class="section" id="exercise-motor-drive-with-acceleration-ramp">
<h3>Exercise: motor drive with acceleration ramp<a class="headerlink" href="#exercise-motor-drive-with-acceleration-ramp" title="Permalink to this headline">¶</a></h3>
<p>In this exercise you are going to develop a motor drive which has an adjustable acceleration, and deceleration ramp. I.e. when the motor is started there will be a acceleration period where the armature voltage is increased linearly from zero, and up to the configured voltage.</p>
<ol class="arabic simple">
<li><p>Use the program you have developed in the previous exercise as a starting point. Make sure everything in that exercise is working as expected</p></li>
<li><p>Add a routine to slowly accelerate the motor from standstill and up to the potentiometer setting. A parameter (const variable) should set the acceleration time, and it should support at least 0 to 20 seconds.</p></li>
<li><p>Add a routine to slowly decelerate the motor from nominal operation and down to standstill. If the stop button is pressed while the motor is accelerating, the deceleration routine should take precedence and use the correct portion of the configured deceleration delay down to standstill.</p></li>
</ol>
</div>
<div class="section" id="advanced-motor-drive-example">
<h3>Advanced motor drive example<a class="headerlink" href="#advanced-motor-drive-example" title="Permalink to this headline">¶</a></h3>
<p>In the following example a potentiometer is used to control the voltage level (i.e. speed) of the motor, one push button changes rotation direction, and the other turns the drive on and off. The main idea is pretty much the same as the first program. The code is a bit more sophisticated and safer to use. The control software is built around a hierarchical <a class="reference external" href="https://www.wikiwand.com/en/Finite-state_machine">State Machine</a>, that simplifyes the management of the different states in which the motor drive may be operating. Put attention of the usage of <code class="code docutils literal notranslate"><span class="pre">typedef</span></code>.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/dc_motor_drive_potmeter_control_bb.png"><img alt="../../_images/dc_motor_drive_potmeter_control_bb.png" src="../../_images/dc_motor_drive_potmeter_control_bb.png" style="width: 757.5px; height: 661.5px;" /></a>
</div>
<p>The following state diagram depicts the operation of the software:</p>
<p class="plantuml">
<img src="../../_images/plantuml-211d8b3e18ba1dff509a87cac8bff4e77471ffe4.png" alt="[*] --&gt; STOPPED

STOPPED -&gt; RUNNING : enable_button
RUNNING -&gt; STOPPED : enable_button
STOPPED: motor_control(0, 0);

RUNNING: duty_cycle = analogRead(control_voltage)/4;
state RUNNING {
  [*] --&gt; FORWARD
  FORWARD -&gt; REVERSE : direction_button
  REVERSE -&gt; FORWARD : direction_button

  FORWARD: motor_control(duty_cycle, FORWARD);
  REVERSE: motor_control(duty_cycle, REVERSE);
}"/>
</p>
<p>The following source code listing is the complete software for the motor drive:</p>
<div class="toggle docutils container">
<div class="header docutils container">
<p><strong>Show/Hide Code</strong></p>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span><span class="cp"></span>

<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">enable1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">input1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">input2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">enable_button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">direction_button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">control_voltage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A0</span><span class="p">;</span><span class="w"></span>

<span class="c1">//#define DEBUG</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">FORWARD</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">REVERSE</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">direction_t</span><span class="p">;</span><span class="w"></span>

<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">RUNNING</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">STOPPED</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">motor_state_t</span><span class="p">;</span><span class="w"></span>


<span class="kt">void</span><span class="w"> </span><span class="nf">motor_control</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">direction_t</span><span class="w"> </span><span class="n">direction</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">buttonPressed_debounce</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">digital_input</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">debounce_delay</span><span class="p">);</span><span class="w"></span>



<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">(){</span><span class="w"></span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">enable1</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">input1</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">input2</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">enable_button</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">direction_button</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">(){</span><span class="w"></span>

<span class="w">  </span><span class="n">motor_state_t</span><span class="w"> </span><span class="n">motor_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STOPPED</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">direction_t</span><span class="w"> </span><span class="n">motor_direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FORWARD</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">duty_cycle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="p">(;;){</span><span class="w"></span>

<span class="w">    </span><span class="n">duty_cycle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">analogRead</span><span class="p">(</span><span class="n">control_voltage</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cp">#ifdef DEBUG</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Duty cycle: &quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="cp">#endif</span>
<span class="w">    </span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * State machine for motor control.</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">motor_state</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">RUNNING</span><span class="p">:</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">buttonPressed_debounce</span><span class="p">(</span><span class="n">enable_button</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">)){</span><span class="w"></span>
<span class="w">        </span><span class="n">motor_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STOPPED</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Motor stopped.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">motor_direction</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="nl">FORWARD</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">buttonPressed_debounce</span><span class="p">(</span><span class="n">direction_button</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">)){</span><span class="w"></span>
<span class="w">          </span><span class="n">motor_direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">REVERSE</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Motor direction reversed.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">motor_control</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">FORWARD</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="nl">REVERSE</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">buttonPressed_debounce</span><span class="p">(</span><span class="n">direction_button</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">)){</span><span class="w"></span>
<span class="w">          </span><span class="n">motor_direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FORWARD</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Motor direction forward.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">motor_control</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">REVERSE</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="n">motor_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STOPPED</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">STOPPED</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">buttonPressed_debounce</span><span class="p">(</span><span class="n">enable_button</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">)){</span><span class="w"></span>
<span class="w">        </span><span class="n">motor_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RUNNING</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Motor enabled.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">motor_control</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">REVERSE</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="n">motor_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STOPPED</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">motor_control</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">direction_t</span><span class="w"> </span><span class="n">direction</span><span class="p">){</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FORWARD</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">input1</span><span class="p">,</span><span class="w"> </span><span class="n">HIGH</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">input2</span><span class="p">,</span><span class="w"> </span><span class="n">LOW</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">input1</span><span class="p">,</span><span class="w"> </span><span class="n">LOW</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">input2</span><span class="p">,</span><span class="w"> </span><span class="n">HIGH</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">analogWrite</span><span class="p">(</span><span class="n">enable1</span><span class="p">,</span><span class="w"> </span><span class="n">duty_cycle</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/*</span>
<span class="cm"> * Check if button is pressed, i.e. if it is high, and it was low before.</span>
<span class="cm"> * This version includes a debounce timer.</span>
<span class="cm"> * </span>
<span class="cm"> * The debounce time is stored as an array of 16 32-bit integers, thus it is</span>
<span class="cm"> * not very memory efficient.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">buttonPressed_debounce</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">digital_input</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">debounce_delay</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">lastStates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// Store the states of digital input 0 - 15.</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">lastEdgeDetect</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"> </span><span class="c1">// Store the time of the last rising edge.</span>
<span class="w">  </span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">digital_input</span><span class="p">);</span><span class="w"></span>


<span class="w">  </span><span class="c1">// Check if the state of the digital input has changed.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">((</span><span class="n">lastStates</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">digital_input</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">lastEdgeDetect</span><span class="p">[</span><span class="n">digital_input</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lastEdgeDetect</span><span class="p">[</span><span class="n">digital_input</span><span class="p">])</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">debounce_delay</span><span class="p">){</span><span class="w"></span>

<span class="w">    </span><span class="n">lastStates</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">digital_input</span><span class="p">;</span><span class="w"> </span><span class="c1">// Store the current state of the digital input.</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">HIGH</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="motor-drive-assignment">
<h3>Motor drive assignment<a class="headerlink" href="#motor-drive-assignment" title="Permalink to this headline">¶</a></h3>
<p>The following circuit is the one used in assignment 5.</p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../../_images/dc_motor_drive_potmeter_control_three_button_9v_battery_bb.png"><img alt="../../_images/dc_motor_drive_potmeter_control_three_button_9v_battery_bb.png" src="../../_images/dc_motor_drive_potmeter_control_three_button_9v_battery_bb.png" style="width: 757.5px; height: 661.5px;" /></a>
</div>
<p>The following state diagram depicts the intended operation of the motor drive in the assignment:</p>
<p class="plantuml">
<img src="../../_images/plantuml-7175e7244f98a053b04ad49bb2fbc27a3bfc0604.png" alt="STATE NORMAL {

  [*] --&gt; STOPPED

  STOPPED -&gt; ACCELERATING : start_stop_button
  ACCELERATING -&gt; RUNNING : setpoint_reached
  ACCELERATING -&gt; BREAKING : start_stop_button
  RUNNING -&gt; BREAKING : start_stop_button
  BREAKING -&gt; STOPPED : zero_reached
  BREAKING -&gt; ACCELERATING : start_stop_button
  STOPPED: motor_control(0, 0);

}

[*] --&gt; NORMAL

NORMAL -&gt; EMERGENCY_STOP : emergency_stop_button
EMERGENCY_STOP -&gt; NORMAL : start_stop_button

EMERGENCY_STOP : motor_control(0, 0);"/>
</p>
</div>
</div>
<div class="section" id="bibliography">
<h2>Bibliography<a class="headerlink" href="#bibliography" title="Permalink to this headline">¶</a></h2>
<span class="target" id="id7"></span></div>
</div>


                </div>
              </div>
            </div>
          </div>
        </div>
        
        
      </div><!-- /row -->

      <!-- row -->
      <div class="row footer-relbar">
<div id="navbar-related" class=" related navbar navbar-default" role="navigation" aria-label="related navigation">
  <div class="navbar-inner">
    <ul class="nav navbar-nav ">
        <li><a href="../../index.html">ELE102 Microcontroller course v1.1.0 documentation</a></li>
    </ul>
<ul class="nav navbar-nav pull-right hidden-xs hidden-sm">
      
        <li><a href="L9_memory_and_architecture.html" title="Microcontroller architecture and Memory technology" >previous</a></li>
        <li><a href="../Lessons-additional/L1_additional.html" title="Additional material for lesson 1" >next</a></li>
        <li><a href="../../genindex.html" title="General Index" >index</a></li>
        <li><a href="#">top</a></li> 
      
    </ul>
  </div>
</div>
      </div><!-- /row -->

      <!-- footer -->
      <footer role="contentinfo">
          &copy; Copyright 2022, Gizem Ateş &amp; Eirik Haustveit.
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 4.4.0.
      </footer>
      <!-- /footer -->

    </div>
    <!-- /container -->

  </body>
</html>